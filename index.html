
<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ù‡Ù…Ø§Ù‡Ù†Ú¯ÛŒ Ø¬Ù„Ø³Ø§Øª Û±Û´Û°Û´</title>
    <script src="https://cdn.jsdelivr.net/npm/jalaali-js/dist/jalaali.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --main: #2563eb; --holiday: #ef4444; --thu: #f59e0b; }
        body { font-family: Tahoma, sans-serif; background: #f8fafc; padding: 20px; color: #1e293b; }
        .container { max-width: 1200px; margin: auto; background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
        .header { text-align: center; margin-bottom: 25px; }
        .input-section { display: flex; gap: 10px; justify-content: center; margin-bottom: 30px; background: #f1f5f9; padding: 20px; border-radius: 12px; }
        input { padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; width: 280px; font-family: Tahoma; outline: none; }
        button { padding: 12px 25px; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        button:hover { background: #059669; }
        
        .calendar-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px; }
        .month-card { border: 1px solid #e2e8f0; border-radius: 12px; padding: 15px; background: #fff; }
        .month-name { text-align: center; font-weight: bold; font-size: 1.2em; margin-bottom: 15px; color: var(--main); }
        .days-header { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-bottom: 10px; }
        .day-label { font-size: 0.75em; color: #64748b; text-align: center; font-weight: bold; }
        .days-body { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
        .day { 
            min-height: 85px; border: 1px solid #f1f5f9; border-radius: 8px; cursor: pointer;
            display: flex; flex-direction: column; align-items: center; padding: 5px; transition: 0.2s; position: relative;
        }
        .day:hover { background: #eff6ff; border-color: #bfdbfe; }
        .day.selected { background: #dbeafe !important; border: 2px solid var(--main); }
        .day.thu { background: #fffbeb; border: 1px solid var(--thu); } /* Ù‡Ø§ÛŒÙ„Ø§ÛŒØª Ù¾Ù†Ø¬Ø´Ù†Ø¨Ù‡ */
        .day.holiday { color: var(--holiday); background: #fef2f2; }
        .day.empty { border: none; cursor: default; background: transparent; }
        
        .day-num { font-weight: bold; font-size: 1em; }
        .vote-badge { font-size: 0.7em; background: #10b981; color: white; border-radius: 12px; padding: 2px 8px; margin-top: 4px; }
        .voters { font-size: 0.6em; color: #475569; text-align: center; margin-top: 5px; line-height: 1.3; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; }
        .today { outline: 2px solid var(--main); background: #f0f9ff; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>ğŸ“… Ù‡Ù…Ø§Ù‡Ù†Ú¯ÛŒ Û¸ Ø¬Ù„Ø³Ù‡ Ù¾Ø§ÛŒØ§Ù†ÛŒ Ø³Ø§Ù„ Û±Û´Û°Û´</h1>
        <p>Ù†Ø§Ù… Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ Ùˆ Ù¾Ù†Ø¬Ø´Ù†Ø¨Ù‡â€ŒÙ‡Ø§ÛŒÛŒ Ú©Ù‡ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø´Ø±Ú©Øª Ú©Ù†ÛŒØ¯ Ø±Ø§ ØªÛŒÚ© Ø¨Ø²Ù†ÛŒØ¯.</p>
    </div>

    <div class="input-section">
        <input type="text" id="userName" placeholder="Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ...">
        <button onclick="submitData()">Ø«Ø¨Øª Ùˆ ØªØ§ÛŒÛŒØ¯ Ù†Ù‡Ø§ÛŒÛŒ</button>
    </div>

    <div class="calendar-grid" id="calendar-container"></div>
</div>

<script>
    // --- Û±. ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¯ÛŒØªØ§Ø¨ÛŒØ³ (Ø­ØªÙ…Ø§Ù‹ Ø¬Ø§ÛŒâ€ŒÚ¯Ø°Ø§Ø±ÛŒ Ú©Ù†ÛŒØ¯) ---
    const SB_URL = 'https://lhecjdhtfzwlnefiliqo.supabase.co';
    const SB_KEY = 'sb_publishable_yVHtrjitGnj62Ms03QZQAA_GCGeM84d';
    const client = supabase.createClient(SB_URL, SB_KEY);

    // --- Û². Ø§Ø·Ù„Ø§Ø¹Ø§Øª ØªÙ‚ÙˆÛŒÙ… (Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø´Ø¯Ù‡ Ø§Ø² Time.ir) ---
    const holidays = { 
        10: [13, 27], // Ø¯ÛŒ: ÙˆÙ„Ø§Ø¯Øª Ø§Ù…Ø§Ù… Ø¹Ù„ÛŒ [cite: 5] Ùˆ Ù…Ø¨Ø¹Ø« 
        11: [15, 22], // Ø¨Ù‡Ù…Ù†: Ù†ÛŒÙ…Ù‡ Ø´Ø¹Ø¨Ø§Ù† Ùˆ Ø§Ù†Ù‚Ù„Ø§Ø¨ 
        12: [20, 29]  // Ø§Ø³ÙÙ†Ø¯: Ø´Ù‡Ø§Ø¯Øª Ø§Ù…Ø§Ù… Ø¹Ù„ÛŒ [cite: 23] Ùˆ Ù…Ù„ÛŒ Ø´Ø¯Ù† Ù†ÙØª
    };
    const monthNames = ["Ø¯ÛŒ", "Ø¨Ù‡Ù…Ù†", "Ø§Ø³ÙÙ†Ø¯"];
    
    let selectedDates = [];
    let allSubmissions = [];

    async function start() {
        await fetchResults(); // Ø¯Ø±ÛŒØ§ÙØª Ø¢Ù…Ø§Ø± Ù‚Ø¨Ù„ÛŒ
        render(); // Ù†Ù…Ø§ÛŒØ´ ØªÙ‚ÙˆÛŒÙ…
    }

    async function fetchResults() {
        const { data, error } = await client.from('availability').select('*');
        if (data) allSubmissions = data;
    }

    function render() {
        const container = document.getElementById('calendar-container');
        container.innerHTML = '';
        [10, 11, 12].forEach(m => container.appendChild(createMonthUI(1404, m)));
    }

    function createMonthUI(y, m) {
        const card = document.createElement('div');
        card.className = 'month-card';
        card.innerHTML = `<div class="month-name">${monthNames[m-10]} ${y}</div>`;
        
        const header = document.createElement('div');
        header.className = 'days-header';
        ["Ø´", "ÛŒ", "Ø¯", "Ø³", "Ú†", "Ù¾", "Ø¬"].forEach(d => header.innerHTML += `<div class="day-label">${d}</div>`);
        card.appendChild(header);

        const body = document.createElement('div');
        body.className = 'days-body';

        const firstG = jalaali.toGregorian(y, m, 1);
        const startDay = (new Date(firstG.gy, firstG.gm-1, firstG.gd).getDay() + 1) % 7;

        for (let i = 0; i < startDay; i++) body.innerHTML += `<div class="day empty"></div>`;

        const totalDays = jalaali.jalaaliMonthLength(y, m);
        for (let d = 1; d <= totalDays; d++) {
            const dateKey = `${y}/${m}/${d}`;
            const isThu = ((startDay + d - 1) % 7 === 5); // Ù¾Ù†Ø¬Ø´Ù†Ø¨Ù‡ 
            const isFri = ((startDay + d - 1) % 7 === 6); // Ø¬Ù…Ø¹Ù‡
            const isOfficial = holidays[m]?.includes(d);
            
            const dayDiv = document.createElement('div');
            dayDiv.className = `day ${isThu ? 'thu' : ''} ${isFri || isOfficial ? 'holiday' : ''}`;
            
            // Ù†Ù…Ø§ÛŒØ´ Ø¢Ø±Ø§ Ùˆ Ø§Ø³Ø§Ù…ÛŒ
            const voters = allSubmissions.filter(s => s.selected_dates.includes(dateKey));
            const namesList = voters.map(v => v.user_name).join('ØŒ ');

            dayDiv.innerHTML = `
                <span class="day-num">${d}</span>
                ${voters.length > 0 ? `<span class="vote-badge">${voters.length} Ù†ÙØ±</span>` : ''}
                <div class="voters" title="${namesList}">${namesList}</div>
            `;

            dayDiv.onclick = () => {
                dayDiv.classList.toggle('selected');
                if (dayDiv.classList.contains('selected')) selectedDates.push(dateKey);
                else selectedDates = selectedDates.filter(t => t !== dateKey);
            };
            body.appendChild(dayDiv);
        }
        card.appendChild(body);
        return card;
    }

    async function submitData() {
        const name = document.getElementById('userName').value.trim();
        if (!name) return alert('Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ Ù†Ø§Ù… Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.');
        if (selectedDates.length === 0) return alert('Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© Ø±ÙˆØ² Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.');

        const { error } = await client.from('availability').insert([
            { user_name: name, selected_dates: selectedDates }
        ]);

        if (error) {
            alert('Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª: ' + error.message);
        } else {
            alert('Ø§Ù†ØªØ®Ø§Ø¨â€ŒÙ‡Ø§ÛŒ Ø´Ù…Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯!');
            location.reload();
        }
    }

    start();
</script>
</body>
</html>