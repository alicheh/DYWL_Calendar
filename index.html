
<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ù‡Ù…Ø§Ù‡Ù†Ú¯ÛŒ Ø¬Ù„Ø³Ø§Øª Û±Û´Û°Û´</title>
    <script src="https://cdn.jsdelivr.net/npm/jalaali-js/dist/jalaali.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --main: #1e40af; --accent: #2563eb; --holiday: #dc2626; --thu: #d97706; --ok: #059669; --muted: #64748b; }
        html,body { height: 100%; }
        body { font-family: Tahoma, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; background: #f8fafc; padding: 20px; color: #0f172a; -webkit-font-smoothing:antialiased; }
        .container { max-width: 1100px; margin: 20px auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 6px 30px rgba(2,6,23,0.06); }
        .header { text-align: center; margin-bottom: 18px; }
        .header h1 { margin: 0 0 6px 0; font-size: 1.5rem; }
        .header p { margin: 0; color: var(--muted); }

        .input-section { display: flex; gap: 12px; align-items: center; justify-content: center; margin-bottom: 18px; background: #f1f5f9; padding: 14px; border-radius: 10px; }
        input[type='text'] { padding: 10px 12px; border: 1px solid #e2e8f0; border-radius: 8px; width: 260px; font-size: 0.95rem; }
        input[type='text']:focus { outline: 3px solid rgba(37,99,235,0.12); border-color: var(--accent); }

        .btn { padding: 10px 14px; background: var(--ok); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; }
        .btn.ghost { background: transparent; color: var(--accent); border: 1px solid #dbeafe; }
        .btn:focus { box-shadow: 0 0 0 3px rgba(5,150,105,0.12); }

        .meta-row { display:flex; gap:12px; justify-content:center; align-items:center; margin-bottom:12px; }
        .summary { background:#f8fafc; padding:10px 12px; border-radius:8px; border:1px solid #eef2ff; color: #0f172a; font-weight:600; }

        .calendar-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; }
        @media (max-width: 980px) { .calendar-grid { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 640px) { .calendar-grid { grid-template-columns: 1fr; } .day { min-height: 68px; } }

        .month-card { border: 1px solid #eef2ff; border-radius: 10px; padding: 12px; background: #fff; }
        .month-name { text-align: center; font-weight: 700; font-size: 1.05rem; margin-bottom: 10px; color: var(--accent); }
        .days-header { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; margin-bottom: 8px; }
        .day-label { font-size: 0.75em; color: var(--muted); text-align: center; font-weight: 700; }
        .days-body { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; }

        .day { 
            min-height: 85px; border: 1px solid #f1f5f9; border-radius: 8px; cursor: pointer;
            display: flex; flex-direction: column; align-items: center; padding: 6px; transition: 0.15s ease; position: relative; background: #ffffff;
        }
        .day:focus { outline: 3px solid rgba(37,99,235,0.12); }
        .day[aria-disabled='true'] { opacity: 0.6; cursor: not-allowed; background: #fff7f7; }
        .day.selected { background: #e6f2ff !important; border: 2px solid var(--accent); }
        .day.thu { background: #fff8e6; border: 1px solid var(--thu); }
        .day.holiday { color: var(--holiday); background: #fff7f7; }
        .day.empty { border: none; cursor: default; background: transparent; }

        .day-num { font-weight: 700; font-size: 0.98em; }
        .vote-badge { font-size: 0.7em; background: var(--accent); color: white; border-radius: 12px; padding: 3px 8px; margin-top: 6px; }
        .voters { font-size: 0.68em; color: var(--muted); text-align: center; margin-top: 6px; line-height: 1.3; max-height: 3.6em; overflow: hidden; }
        .legend { display:flex; gap:8px; justify-content:center; margin:10px 0 0 0; color: var(--muted); }
        .legend .item { display:flex; gap:6px; align-items:center; font-size:0.85rem; }
        .legend .swatch { width:14px; height:14px; border-radius:4px; }

        .notify { display:none; padding:10px 12px; border-radius:8px; margin-bottom:12px; font-weight:600; }
        .notify.show { display:block; }
        .notify.success { background: #ecfdf5; color: #065f46; border: 1px solid #bbf7d0; }
        .notify.error { background: #fff1f2; color: #9f1239; border: 1px solid #fecdd3; }

    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>ğŸ“… Ù‡Ù…Ø§Ù‡Ù†Ú¯ÛŒ Û¸ Ø¬Ù„Ø³Ù‡ Ù¾Ø§ÛŒØ§Ù†ÛŒ Ø³Ø§Ù„ Û±Û´Û°Û´</h1>
        <p>Ù†Ø§Ù… Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ Ùˆ Ù¾Ù†Ø¬Ø´Ù†Ø¨Ù‡â€ŒÙ‡Ø§ÛŒÛŒ Ú©Ù‡ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø´Ø±Ú©Øª Ú©Ù†ÛŒØ¯ Ø±Ø§ ØªÛŒÚ© Ø¨Ø²Ù†ÛŒØ¯.</p>
    </div>

    <div class="input-section" role="region" aria-label="ÙˆØ±ÙˆØ¯ÛŒ Ú©Ø§Ø±Ø¨Ø±">
        <input type="text" id="userName" placeholder="Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ..." aria-label="Ù†Ø§Ù…" autocomplete="name">
        <button class="btn" id="submitBtn" onclick="submitData()">Ø«Ø¨Øª / Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ</button>
        <button class="btn ghost" id="resetBtn" onclick="resetSelection()">Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ Ø§Ù†ØªØ®Ø§Ø¨â€ŒÙ‡Ø§</button>
    </div>

    <div class="meta-row">
        <div class="summary" id="selectionSummary">Ø§Ù†ØªØ®Ø§Ø¨â€ŒØ´Ø¯Ù‡: Û°</div>
        <div class="legend" aria-hidden="false">
            <div class="item"><span class="swatch" style="background:var(--accent);"></span> Ø§Ù†ØªØ®Ø§Ø¨â€ŒØ´Ø¯Ù‡</div>
            <div class="item"><span class="swatch" style="background:var(--thu);"></span> Ù¾Ù†Ø¬â€ŒØ´Ù†Ø¨Ù‡</div>
            <div class="item"><span class="swatch" style="background:var(--holiday);"></span> ØªØ¹Ø·ÛŒÙ„ Ø±Ø³Ù…ÛŒ</div>
        </div>
    </div>

    <div id="notify" class="notify" role="status" aria-live="polite"></div>

    <div class="calendar-grid" id="calendar-container" aria-live="polite"></div>
</div>

<script>
    // --- ØªÙ†Ø¸ÛŒÙ…Ø§Øª Supabase (Ù„Ø·ÙØ§Ù‹ Ú©Ù„ÛŒØ¯Ù‡Ø§ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯) ---
    const SB_URL = 'https://lhecjdhtfzwlnefiliqo.supabase.co';
    const SB_KEY = 'sb_publishable_yVHtrjitGnj62Ms03QZQAA_GCGeM84d';
    const client = supabase.createClient(SB_URL, SB_KEY);

    // ØªØ¹Ø·ÛŒÙ„Ø§Øª Ø±Ø³Ù…ÛŒ (Ù†Ù…ÙˆÙ†Ù‡)
    const holidays = { 10: [13, 27], 11: [15, 22], 12: [20, 29] };
    const monthNames = ["Ø¯ÛŒ", "Ø¨Ù‡Ù…Ù†", "Ø§Ø³ÙÙ†Ø¯"];

    let selectedDates = [];
    let allSubmissions = [];
    let typingTimer = null;

    const summaryEl = document.getElementById('selectionSummary');
    const notifyEl = document.getElementById('notify');
    const nameInput = document.getElementById('userName');

    function notify(msg, type = 'success') {
        notifyEl.textContent = msg;
        notifyEl.className = `notify show ${type}`;
        setTimeout(() => notifyEl.classList.remove('show'), 4500);
    }

    async function start() {
        await fetchResults();
        render();
        attachNameListener();
        updateSummary();
    }

    async function fetchResults() {
        const { data, error } = await client.from('availability').select('*');
        if (error) console.warn('fetch error', error);
        allSubmissions = data || [];
    }

    function updateSummary() {
        summaryEl.textContent = `Ø§Ù†ØªØ®Ø§Ø¨â€ŒØ´Ø¯Ù‡: ${selectedDates.length}`;
    }

    function createMonthUI(y, m) {
        const card = document.createElement('div');
        card.className = 'month-card';
        card.innerHTML = `<div class="month-name">${monthNames[m-10]} ${y}</div>`;

        const header = document.createElement('div');
        header.className = 'days-header';
        ["Ø´","ÛŒ","Ø¯","Ø³","Ú†","Ù¾","Ø¬"].forEach(d => header.innerHTML += `<div class="day-label">${d}</div>`);
        card.appendChild(header);

        const body = document.createElement('div');
        body.className = 'days-body';

        const firstG = jalaali.toGregorian(y, m, 1);
        const startDay = (new Date(firstG.gy, firstG.gm-1, firstG.gd).getDay() + 1) % 7;

        for (let i = 0; i < startDay; i++) body.innerHTML += `<div class="day empty"></div>`;

        const totalDays = jalaali.jalaaliMonthLength(y, m);
        for (let d = 1; d <= totalDays; d++) {
            const dateKey = `${y}/${m}/${d}`;
            const weekdayIndex = (startDay + d - 1) % 7;
            const isThu = (weekdayIndex === 5);
            const isOfficial = holidays[m]?.includes(d);
            const isSelectable = isThu && !isOfficial;

            const voters = allSubmissions.filter(s => Array.isArray(s.selected_dates) && s.selected_dates.includes(dateKey));
            const namesList = voters.map(v => v.user_name).join('ØŒ ');

            const dayDiv = document.createElement('div');
            dayDiv.className = 'day';
            if (isThu) dayDiv.classList.add('thu');
            if (isOfficial) dayDiv.classList.add('holiday');
            if (!isSelectable) dayDiv.setAttribute('aria-disabled', 'true');
            dayDiv.setAttribute('role', isSelectable ? 'button' : 'img');
            dayDiv.setAttribute('data-date', dateKey);
            dayDiv.tabIndex = isSelectable ? 0 : -1;

            dayDiv.innerHTML = `
                <span class="day-num">${d}</span>
                ${voters.length > 0 ? `<span class="vote-badge">${voters.length} Ù†ÙØ±</span>` : ''}
                <div class="voters" title="${namesList}">${namesList}</div>
            `;

            if (isSelectable) {
                dayDiv.addEventListener('click', () => toggleDate(dayDiv, dateKey));
                dayDiv.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); toggleDate(dayDiv, dateKey); } });
                // Pre-select if current user has this date
                if (selectedDates.includes(dateKey)) dayDiv.classList.add('selected');
            }
            body.appendChild(dayDiv);
        }

        card.appendChild(body);
        return card;
    }

    function toggleDate(el, dateKey) {
        if (el.getAttribute('aria-disabled') === 'true') return;
        const idx = selectedDates.indexOf(dateKey);
        if (idx === -1) selectedDates.push(dateKey);
        else selectedDates.splice(idx, 1);
        el.classList.toggle('selected');
        updateSummary();
    }

    function render() {
        const container = document.getElementById('calendar-container');
        container.innerHTML = '';
        [10,11,12].forEach(m => container.appendChild(createMonthUI(1404, m)));
    }

    function resetSelection() {
        selectedDates = [];
        document.querySelectorAll('.day.selected').forEach(el => el.classList.remove('selected'));
        updateSummary();
    }

    function attachNameListener() {
        nameInput.addEventListener('input', () => {
            clearTimeout(typingTimer);
            typingTimer = setTimeout(fetchUserSelectionByName, 700);
        });
        nameInput.addEventListener('keydown', () => clearTimeout(typingTimer));
    }

    async function fetchUserSelectionByName() {
        const name = nameInput.value.trim();
        if (!name) return;
        const { data, error } = await client.from('availability').select('*').eq('user_name', name).limit(1);
        if (error) { console.warn(error); return; }
        if (data && data.length > 0) {
            selectedDates = data[0].selected_dates || [];
            // re-render to reflect selections
            render();
            updateSummary();
            notify('Ø§Ù†ØªØ®Ø§Ø¨â€ŒÙ‡Ø§ÛŒ Ù‚Ø¨Ù„ÛŒ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯ â€” Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø¢Ù†Ù‡Ø§ Ø±Ø§ ÙˆÛŒØ±Ø§ÛŒØ´ Ú©Ù†ÛŒØ¯.', 'success');
        }
    }

    async function submitData() {
        const name = document.getElementById('userName').value.trim();
        if (!name) { notify('Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.', 'error'); return; }
        if (selectedDates.length === 0) { notify('Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© Ù¾Ù†Ø¬â€ŒØ´Ù†Ø¨Ù‡ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.', 'error'); return; }

        try {
            // Ú†Ú© Ø¨Ø±Ø§ÛŒ ÙˆØ¬ÙˆØ¯ Ø±Ú©ÙˆØ±Ø¯ Ø¨Ø±Ø§ÛŒ Ù‡Ù…ÛŒÙ† Ù†Ø§Ù…
            const { data: existing } = await client.from('availability').select('id').eq('user_name', name).limit(1);
            if (existing && existing.length > 0) {
                const { error } = await client.from('availability').update({ selected_dates: selectedDates }).eq('user_name', name);
                if (error) throw error;
                notify('Ø§Ù†ØªØ®Ø§Ø¨â€ŒÙ‡Ø§ÛŒ Ø´Ù…Ø§ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯.', 'success');
            } else {
                const { error } = await client.from('availability').insert([{ user_name: name, selected_dates: selectedDates }]);
                if (error) throw error;
                notify('Ø§Ù†ØªØ®Ø§Ø¨â€ŒÙ‡Ø§ÛŒ Ø´Ù…Ø§ Ø«Ø¨Øª Ø´Ø¯. Ù…ØªØ´Ú©Ø±Ù…!', 'success');
            }
            await fetchResults();
            render();
            updateSummary();
        } catch (err) {
            console.error(err);
            notify('Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ: ' + (err.message || err), 'error');
        }
    }

    // initialize
    start();
</script>
</body>
</html>